<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>lib/class/map/Map.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/tonylukasavage/lucid-dream" target="_blank" class="menu-item" id="github-link" >Github</a></h2><h2><a href="https://discord.gg/BHJ964k" target="_blank" class="menu-item" id="github-link" >Discord</a></h2><h3>Classes</h3><ul><li><a href="Apply.html">Apply</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Apply.html#toDict">toDict</a></li></ul></li><li><a href="Decal.html">Decal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Decal.html#toDict">toDict</a></li></ul></li><li><a href="Effect.html">Effect</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Effect.html#toDict">toDict</a></li></ul></li><li><a href="Entity.html">Entity</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Entity.html#toDict">toDict</a></li></ul></li><li><a href="Filler.html">Filler</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Filler.html#toDict">toDict</a></li></ul></li><li><a href="Lucid.html">Lucid</a></li><li><a href="Map.html">Map</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Map.html#decode">decode</a></li><li data-type='method' style='display: none;'><a href="Map.html#encode">encode</a></li><li data-type='method' style='display: none;'><a href="Map.html#toDict">toDict</a></li></ul></li><li><a href="ObjectTiles.html">ObjectTiles</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ObjectTiles.html#size">size</a></li></ul></li><li><a href="Parallax.html">Parallax</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Parallax.html#toDict">toDict</a></li></ul></li><li><a href="Room.html">Room</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Room.html#toDict">toDict</a></li></ul></li><li><a href="Side.html">Side</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Side.html#decode">decode</a></li><li data-type='method' style='display: none;'><a href="Side.html#encode">encode</a></li></ul></li><li><a href="Spinner.html">Spinner</a></li><li><a href="Style.html">Style</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Style.html#toDict">toDict</a></li></ul></li><li><a href="Tiles.html">Tiles</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Tiles.html#minimizeTilesString">minimizeTilesString</a></li><li data-type='method' style='display: none;'><a href="Tiles.html#size">size</a></li></ul></li><li><a href="Trigger.html">Trigger</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Trigger.html#toDict">toDict</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/class/map/Map.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const MapDecoder = require('./MapDecoder');
const MapEncoder = require('./MapEncoder');
const { attributes, children, findChildWithName } = require('../../utils');
const {
	Apply,
	Decal,
	Effect,
	Entity,
	Filler,
	ObjectTiles,
	Parallax,
	Room,
	Style,
	Tiles,
	Trigger
} = require('../');

class Map {

	/**
	 * Create a Map instance
	 * @constructor
	 * @param {Object} [data={}] - An object defining the properties of the map
	 * @example
	 * // returns a new Map
	 * const { Map } = require('lucid-dream');
	 * const map = new Map();
	 * @property {String} [name=Lucid Dream Default] - The name of the map
	 * @property {String} package - The name of the map package
	 * @property {Array} rooms - An Array of {@link Room} instances
	 * @property {Style} style - An instance of {@link Style}
	 * @property {Array} fillers - An Array of {@link Filler} instances
	 */
	constructor(data = {}) {
		Object.assign(this, {
			package: 'lucid',
			rooms: [],
			style: new Style(),
			fillers: []
		}, data);
	}

	/**
	 * Decodes a map from a `.bin` file
	 * @param {String} file - The path to the `.bin` file to decode
	 * @example
	 * // decodes a map
	 * const { Map } = require('lucid-dream');
	 * const map = new Map();
	 * await map.decode('/path/to/my-map.bin');
	 * @returns {Object} The decoded map data
	 */
	async decode(file) {
		const decoder = new MapDecoder(this, file);
		const data = await decoder.readMap();
		const pkg = data._package;
		const roomsData = findChildWithName(data, 'levels');
		const style = findChildWithName(data, 'Style');
		const fgStyle = loadBackdrops(findChildWithName(style, 'Foregrounds'));
		const bgStyle = loadBackdrops(findChildWithName(style, 'Backgrounds'));
		const fillerRects = loadFillerRects(findChildWithName(data, 'Filler'));

		const rooms = children(roomsData).reduce((a,c) => {
			a.push(loadRoom(c));
			return a;
		}, []);

		Object.assign(this, {
			package: pkg,
			rooms,
			style: new Style(fgStyle, bgStyle),
			fillers: fillerRects
		});

		return data;
	}

	/**
	 * Encodes map data to a `.bin` file
	 * @param {Object} data - {@link Map} data
	 * @param {String} file - The path to the `.bin` file to which to encode
	 * @example
	 * // encodes a map
	 * const { Map } = require('lucid-dream');
	 * const map = new Map();
	 * await map.decode('/path/to/my-map.bin');
	 * // make your changes to the map
	 * await map.encode(map.data, '/path/to/my-new-map.bin');
	 * @returns {null}
	 */
	async encode(data, file) {
		const encoder = new MapEncoder(data);
		await encoder.encode(file);
	}

	/**
	 * Encode a map into a dictionary
	 * @example
	 * // returns encoded map dictionary
	 * const { Map } = require('lucid-dream');
	 * const map = new Map();
	 * map.toDict();
	 * @returns {Object} An object containing the encoded map dicitonary
	 */
	toDict() {
		return {
			_package: this.package,
			__name: 'Map',
			__children: [
				{
					__name: 'levels',
					__children: this.rooms.map(r => r.toDict())
				},
				{
					__name: 'Style',
					__children: this.style.toDict()
				},
				{
					__name: 'Filler',
					__children: this.fillers.map(f => f.toDict())
				}
			]
		};
	}

}

/*********************/
/* private functions */
/*********************/

function loadBackdrops(styleData) {
	const backdrops = [];

	for (let child of children(styleData)) {
		const styleType = child.__name;

		if (styleType === 'parallax') {
			backdrops.push(new Parallax(attributes(child)));
		} else if (styleType === 'apply') {
			const applyAttr = attributes(child);
			const parallax = [];

			for (let data of children(child)) {
				const typ = data.__name;
				if (typ === 'parallax') {
					parallax.push(new Parallax(attributes(data)));
				} else {
					parallax.push(new Effect(typ, attributes(data)));
				}
			}

			backdrops.push(new Apply(applyAttr, parallax));
		} else {
			backdrops.push(new Effect(styleType, attributes(child)));
		}
	}

	return backdrops;
}

function loadFillerRects(fillerData) {
	const fillers = [];

	for (let child of children(fillerData)) {
		fillers.push(new Filler(child.x, child.y, child.w, child.h));
	}

	return fillers;
}

function loadDecals(roomData, isFg = true) {
	const decals = [];
	const key = isFg ? 'fgdecals' : 'bgdecals';

	for (let child of children(findChildWithName(roomData, key))) {
		decals.push(new Decal(child.texture, child.x, child.y, child.scaleX, child.scaleY));
	}

	return decals;
}

function loadEntities(roomData, key) {
	const entities = [];
	const func = key === 'entities' ? Entity : Trigger;

	for (let child of (children(findChildWithName(roomData, key)))) {
		let id = child.id == null ? -1 : child.id;
		id = Number.isInteger(id) ? id : 0;
		delete child.id;

		const nodesRaw = children(child);

		if (nodesRaw &amp;&amp; nodesRaw.length) {
			child.nodes = nodesRaw.reduce((a,c) => {
				a.push([c.x, c.y]);
				return a;
			}, []);
		}
		entities.push(new func(child.__name, attributes(child), id));
	}

	return entities;
}


function loadRoom(roomData) {
	const fgDecals = loadDecals(roomData, true);
	const bgDecals = loadDecals(roomData, false);

	const entities = loadEntities(roomData, 'entities');
	const triggers = loadEntities(roomData, 'triggers');

	const fgTilesRaw = findChildWithName(roomData, 'solids').innerText || '';
	const bgTilesRaw = findChildWithName(roomData, 'bg').innerText || '';
	const objTilesRaw = findChildWithName(roomData, 'objtiles').innerText || '';

	const fgTiles = new Tiles(fgTilesRaw);
	const bgTiles = new Tiles(bgTilesRaw);
	const objTiles = new ObjectTiles(objTilesRaw);

	const room = new Room({
		name: roomData.name || 'lvl_1',
		position: [ roomData.x, roomData.y ],
		size: [ roomData.width, roomData.height ],
		entities,
		triggers,
		bgDecals,
		fgDecals,
		fgTiles,
		bgTiles,
		objTiles,
		musicLayer1: roomData.musicLayer1 || true,
		musicLayer2: roomData.musicLayer2 || true,
		musicLayer3: roomData.musicLayer3 || true,
		musicLayer4: roomData.musicLayer4 || true,
		musicProgress: roomData.musicProgress || '',
		ambienceProgress: roomData.ambienceProgress || '',
		dark: roomData.dark || false,
		space: roomData.space || false,
		underwater: roomData.underwater || false,
		whisper: roomData.whisper || false,
		disableDownTransition: roomData.disableDownTransition || false,
		delayAltMusicFade: roomData.delayAltMusicFade || false,
		music: roomData.music || 'music_oldsite_awake',
		altMusic: roomData.altMusic || '',
		windPattern: roomData.windPattern || 'None',
		color: roomData.c || 0,
		cameraOffsetX: roomData.cameraOffsetX || 0,
		cameraOffsetY: roomData.cameraOffsetY || 0
	});

	return room;
}

module.exports = Map;

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Thu May 14 2020 14:49:49 GMT-0400 (Eastern Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
